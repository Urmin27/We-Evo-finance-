<!DOCTYPE html>
<html lang="mg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVO Finance Service</title>
  <style>
    /* CSS Global */
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background: #333;
      color: #fff;
      text-align: center;
      padding: 1rem 0;
    }
    /* Main Content – tsy miseho raha tsy vita verification */
    #main-content {
      display: none;
    }
    section {
      background: #fff;
      margin: 1rem auto;
      padding: 1rem;
      border-radius: 8px;
      max-width: 800px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2, h3 {
      margin-top: 0;
      color: #333;
    }
    .account-info {
      display: flex;
      justify-content: space-around;
    }
    .account-info div {
      text-align: center;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 40%;
      background: #fafafa;
    }
    .transaction-buttons {
      text-align: center;
      margin-bottom: 1rem;
    }
    .transaction-buttons button {
      margin: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      background: #007BFF;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .transaction-buttons button:hover {
      background: #0056b3;
    }
    form {
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    form label {
      display: block;
      margin: 0.5rem 0 0.2rem;
    }
    form input, form select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form button {
      padding: 0.5rem 1rem;
      border: none;
      background: #28a745;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    form button:hover {
      background: #218838;
    }
    /* Section TRADING */
    #trading {
      text-align: center;
    }
    .trading-container {
      margin-top: 1rem;
    }
    .trading-button {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      font-size: 1rem;
      color: #fff;
      background: #17a2b8;
      cursor: pointer;
      transition: background 0.3s;
    }
    #trading-status {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    #notification-trading {
      margin-top: 1rem;
      background: #d1ecf1;
      padding: 1rem;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      color: #0c5460;
      display: none;
    }
    #notification-trading button {
      padding: 0.5rem 1rem;
      border: none;
      background: #17a2b8;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    /* Historique */
    #historique-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 0.5rem;
      background: #fff;
    }
    .historique-item {
      border-bottom: 1px solid #eee;
      padding: 0.5rem 0;
    }
    /* Tabilao de Confirmation (Admin) */
    #confirmation-table {
      margin-top: 2rem;
    }
    #confirmation-table h2 {
      text-align: center;
    }
    #confirmation-access {
      text-align: center;
      margin-bottom: 1rem;
    }
    #confirmation-access input {
      padding: 0.5rem;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #confirmation-access button {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      border: none;
      background: #17a2b8;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #confirmation-container {
      display: none;
    }
    #confirmation-container table {
      width: 100%;
      border-collapse: collapse;
    }
    #confirmation-container th, #confirmation-container td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    #confirmation-container th {
      background: #f0f0f0;
    }
    #confirmation-container button {
      padding: 0.3rem 0.6rem;
      background: #17a2b8;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 2px;
    }
    /* Formulaire Registre CIN – ho an'ireo tsy mbola voasoratra */
    #registration-cin {
      max-width: 800px;
      margin: 1rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    #registration-cin h2 {
      margin-top: 0;
    }
    #registration-cin form label {
      display: block;
      margin: 0.5rem 0 0.2rem;
    }
    #registration-cin form input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #registration-cin form button {
      padding: 0.5rem 1rem;
      border: none;
      background: #007BFF;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    #registration-cin form button:hover {
      background: #0056b3;
    }
    /* Notification (2 sec) */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    
    
    /* Styles généraux */
#extra-sections {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    padding: 20px;
    background: linear-gradient(to right, #0a3d62, #1e3799);
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
}

/* Boutons de lien */
.link-button {
    text-decoration: none;
    font-size: 16px;
    font-weight: bold;
    color: white;
    background: linear-gradient(to right, #78c7ff, #4a69bd);
    padding: 12px 20px;
    border-radius: 25px;
    transition: all 0.3s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

/* Effet au survol */
.link-button:hover {
    transform: scale(1.1);
    background: linear-gradient(to right, #4a69bd, #78c7ff);
    box-shadow: 0px 4px 15px rgba(255, 255, 255, 0.3);
}

/* Effet de dessin (animation sous le bouton) */
.link-button::after {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: -100%;
    background: rgba(255, 255, 255, 0.2);
    transition: left 0.4s ease-in-out;
}

.link-button:hover::after {
    left: 100%;
}







/* En-tête de profil */
.profile-header {
  position: relative;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
  background-color: #fff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Zone de la photo de couverture */
.cover-photo {
  position: relative;
  width: 100%;
  height: 300px;
  overflow: hidden;
  background: linear-gradient(to right, #0a3d62, #1e3799);
}

.cover-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Bouton d'upload (pour couverture et profil) */
.upload-button {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background-color: rgba(0,0,0,0.5);
  color: #fff;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  transition: background-color 0.3s;
}

.upload-button:hover {
  background-color: rgba(0,0,0,0.7);
}

/* Zone de la photo de profil */
.profile-photo-container {
  position: absolute;
  left: 20px;
  bottom: -50px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Photo de profil circulaire */
.profile-photo {
  width: 100px;
  height: 100px;
  border: 5px solid #fff;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  background: #fff;
}

.profile-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Modal pour agrandir l'image */
.modal {
  display: none;
  position: fixed;
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
}

.modal-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 80%;
  margin-top: 5%;
}

.close {
  position: absolute;
  top: 20px;
  right: 35px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}

/* Responsive design pour petits écrans */
@media screen and (max-width: 600px) {
  .profile-photo-container {
    left: 50%;
    transform: translateX(-50%);
  }
}

  </style>
</head>
<body>
  <header>
    <h1>EVO Finance Service</h1>((((()))))
  </header>()
  
  
  
  
  
  
    <!-- Start of LiveChat (www.livechat.com) code -->
<script>
    window.__lc = window.__lc || {};
    window.__lc.license = 19042465;
    window.__lc.integration_name = "manual_channels";
    window.__lc.product_name = "livechat";
    ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>
<noscript><a href="https://www.livechat.com/chat-with/19042465/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code -->










  

  <!-- Main Content (miseho rehefa efa voamarina ny CIN) -->
  

  <div id="main-content">
      
      
            <section><!-- Section En-tête avec photo de couverture et photo de profil -->
  <div class="profile-header">
    <!-- Photo de couverture -->
    <div class="cover-photo" id="coverPhoto">
      <img src="cover-placeholder.jpg" alt="Photo de couverture" id="coverImg">
      <!-- Bouton d'upload (affiché sur la photo) -->
      <button class="upload-button" id="uploadCover"></button>
      <!-- Input caché pour uploader l'image -->
      <input type="file" id="coverInput" accept="image/*" style="display: none;">
    </div>
    <!-- Photo de profil qui chevauche la couverture -->
    <div class="profile-photo-container">
      <div class="profile-photo" id="profilePhoto">
        <img src="profile-placeholder.jpg" alt="Photo de profil" id="profileImg">
      </div>
      <!-- Bouton d'upload pour la photo de profil -->
      <button class="upload-button" id="uploadProfile"></button>
      <input type="file" id="profileInput" accept="image/*" style="display: none;">
    </div>
  </div>
  
    <!-- Section: Mon compte -->
    <section id="mon-compte">
      <h2>Mon compte</h2>
      <div class="account-info">
        <div class="compte-depot">
          <h3>Solde du dépôt</h3>
          <p id="soldeDepot">0$</p>
        </div>
        <div class="compte-gains">
          <h3>Solde du gains</h3>
          <p id="soldeGains">0$</p>
        </div>
      </div>
    </section>
    
    
    
    
    
    
    
    
    


  <!-- Modal pour afficher la photo de profil en grand -->
  <div id="modal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImg">
  </div></section>
  
  
  
  
    

  
    <!-- Section: TRANSACTION -->
    <section id="transaction">
      <h2>Transaction</h2>
      <div class="transaction-buttons">
        <button id="btn-depot">Faire un dépôt</button>
        <button id="btn-retrait">Faire un retrait</button>
        <button id="btn-transfert">Faire une transfert d'argent</button>
      </div>
      <div class="transaction-forms">
        <!-- Formulaire Dépôt -->
        <form id="form-depot" style="display: none;">
          <h3>Dépôt</h3>
          <label for="depot-montant">Montant:</label>
          <input type="number" id="depot-montant" min="10" placeholder="Minimum 10$" required>
          <label for="adresse-depot">Adresse du dépôt:</label>
          <select id="adresse-depot">
            <option value="P1121911473">P1121911473</option>
            <option value="P1121911473">P1121911473</option>
          </select>
          <button type="button" onclick="copyAdresse()">Copier l'adresse</button>
          <label for="id-transaction">Id de transaction:</label>
          <input type="text" id="id-transaction" required>
          <button type="submit">Valider le dépôt</button>
        </form>
        
        <!-- Formulaire Retrait -->
        <form id="form-retrait" style="display: none;">
          <h3>Retrait</h3>
          <label for="retrait-montant">Montant à retrait:</label>
          <input type="number" id="retrait-montant" min="1" placeholder="Minimum 1$" required>
          <label for="adresse-retrait">Adresse du retrait: PAYEER UNIQUEMENT </label>
          <input type="text" required>
          <button type="submit">Valider le retrait</button>
        </form>
        
        <!-- Formulaire Transfert d'argent -->
        <form id="form-transfert" style="display: none;">
          <h3>Transfert d'argent</h3>
          <label for="transfert-montant">Montant à transférer:</label>
          <input type="number" id="transfert-montant" min="5" placeholder="Minimum 5$" required>
          <label for="email-utilisateur">Email de l'utilisateur destinataire:</label>
          <input type="email" id="email-utilisateur" required>
          <label for="reception-type">Réception :</label>
          <select id="reception-type" required>
            <option value="depot">Solde du dépôt</option>
            <option value="gains">Solde du gains</option>
          </select>
          <button type="submit">Envoyer</button>
        </form>
      </div>
    </section>
    
    <!-- Section: TRADING -->
    <section id="trading">
      <h2>Trading</h2>
      <div class="trading-container">
        <button id="btn-trading" class="trading-button">Trading</button>
        <p id="trading-status">Cliquez sur Trading pour commencer</p>
        <div id="notification-trading">
          <p>Le robot EVO FINANCE vous offre <span id="gain-robot">0$</span></p>
          <button id="btn-ajouter-gains">Ajouter au compte du gains</button>
        </div>
      </div>
    </section>
    <section>
        
        <!-- Section Extra : Liens vers d'autres pages -->
  <div id="extra-sections">((()))
    <a href="https://evo-finance-seven.vercel.app/" target="_blank" class="link-button">Entreprise</a>
    <a href="https://evo-finance-quipe-ivl7.vercel.app/" target="_blank" class="link-button">Gestion d'équipes</a>
    <a href="https://evo-finance-guide.vercel.app/" target="_blank" class="link-button">Guide complet</a>
    <a href="https://evo-finance-bot-f1po.vercel.app/" target="_blank" class="link-button">Besoin d'aide ?</a>
    <a href="https://evo-finance-demande-du-d-p-t.vercel.app/" target="_blank" class="link-button">Dépôt Evo. Fin</a>
    <a href="https://evo-finance-demande-retrait.vercel.app/" target="_blank" class="link-button">Retrait Evo. Fin</a>
    <a href="https://plan-de-travail.vercel.app/" target="_blank" class="link-button">plan d'investissement</a>
  </div>
    <!-- Section: Historique -->
    <section id="historique">
      <h2>Historique</h2>
      <div id="historique-container">
        <!-- Historique des transactions s'affichera ici -->
      </div>
    </section>
    
    </section>
    <!-- Section: Tabilao de Confirmation (Admin) -->
    <section id="confirmation-table">
      <h2>Recherche sur EVO FINANCE </h2>
      <div id="confirmation-access">
        <label for="admin-code"> :</label>
        <input type="password" id="admin-code" placeholder="">
        <button id="btn-show-confirmation">voir</button>
      </div>
      <div id="confirmation-container">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Montant</th>
              <th>Adresse / Email</th>
              <th>ID Transaction</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="confirmation-body">
            <!-- Les lignes seront insérées ici -->
          </tbody>
        </table>
      </div>
    </section>
  </div>
  
  <!-- Section: Registre CIN (ho an'ireo tsy mbola voasoratra) – aseho amin'ny farany ambany -->
  <section id="registration-cin">
    <h2>Enregistrement CIN</h2>
    <form id="form-registration-cin">
      <label for="reg-email">E-mail :</label>
      <input type="email" id="reg-email" required>
      <label for="reg-cin">Numero de CIN :</label>
      <input type="text" id="reg-cin" required>
      <label for="reg-nom">Nom complet :</label>
      <input type="text" id="reg-nom" required>
      <label for="reg-password">Mot de passe :</label>
      <input type="password" id="reg-password" required>
      <button type="submit">Enregistrer</button>
    </form>
  </section>
  
  

  
  
  
  <!-- Section: Vérification CIN -->
  <section id="verification-cin">
    <h2>Vérification CIN</h2>
    <form id="form-verification-cin">
      <label for="verification-email">E-mail :</label>
      <input type="email" id="verification-email" required>
      <label for="verification-cin-input">Numero de CIN :</label>
      <input type="text" id="verification-cin-input" required>
      <label for="verification-password">Mot de passe :</label>
      <input type="password" id="verification-password" required>
      <button type="submit">Vérifier</button>
    </form>
  </section>
  


  <!-- Modal pour afficher la photo de profil en grand -->
  <div id="modal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="modalImg">
  </div>
  </section>
  
  <!-- Firebase & Logique -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, setDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDbAk8VyG7gfzmmFAFLAnUtUi1XrSNrQQQ",
      authDomain: "evo-finance-service.firebaseapp.com",
      projectId: "evo-finance-service",
      storageBucket: "evo-finance-service.appspot.com",
      messagingSenderId: "231632509264",
      appId: "1:231632509264:web:03cf6b9e2ef75a4f7bb455",
      measurementId: "G-2561NK5LL8"
    };
    
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Global variable for current user (après verification)
    let currentUser = null;
    let soldeDepot = 0;
    let soldeGains = 0;
    let currentGain = 0;
    
    // --- Formulaire Registre CIN ---
    document.getElementById('form-registration-cin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('reg-email').value.trim();
      const cin = document.getElementById('reg-cin').value.trim();
      const nom = document.getElementById('reg-nom').value.trim();
      const password = document.getElementById('reg-password').value;
      if(!email || !cin || !nom || !password) {
        showNotification("Veuillez remplir tous les champs pour l'enregistrement.");
        return;
      }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        // Enregistrer les données dans Firestore, avec verified = false
        await setDoc(doc(db, "utilisateurs", user.uid), { email, cin, nom, verified: false, timestamp: new Date() });
        // Créer un document balances pour cet utilisateur
        await setDoc(doc(db, "balances", user.uid), { soldeDepot: 0, soldeGains: 0 });
        showNotification("Enregistrement CIN réussi. Veuillez ensuite vérifier votre CIN.");
      } catch (error) {
        console.error("Erreur lors de l'enregistrement CIN: ", error);
        showNotification("Erreur: " + error.message);
      }
    });
    
    // --- Formulaire Vérification CIN ---
    document.getElementById('form-verification-cin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('verification-email').value.trim();
      const cinInput = document.getElementById('verification-cin-input').value.trim();
      const password = document.getElementById('verification-password').value;
      if(!email || !cinInput || !password) {
        showNotification("Veuillez remplir tous les champs.");
        return;
      }
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userRef = doc(db, "utilisateurs", user.uid);
        const userSnap = await getDoc(userRef);
        if(userSnap.exists()){
          const userData = userSnap.data();
          if(userData.cin === cinInput){
            currentUser = { uid: user.uid, email, cin: cinInput, ...userData };
            await updateDoc(userRef, { verified: true });
            showNotification("Vérification réussie.");
            document.getElementById('main-content').style.display = "block";
            // Afeno ny fizarana registre sy verification
            document.getElementById('registration-cin').style.display = "none";
            document.getElementById('verification-cin').style.display = "none";
            loadBalance();
          } else {
            showNotification("Le numéro de CIN ne correspond pas.");
          }
        } else {
          showNotification("Utilisateur introuvable.");
        }
      } catch (error) {
        console.error("Erreur lors de la vérification: ", error);
        showNotification("Erreur: " + error.message);
      }
    });
    
    async function loadBalance() {
      if(currentUser) {
        const balanceRef = doc(db, "balances", currentUser.uid);
        const balanceSnap = await getDoc(balanceRef);
        if(balanceSnap.exists()){
          const data = balanceSnap.data();
          soldeDepot = data.soldeDepot || 0;
          soldeGains = data.soldeGains || 0;
        } else {
          await setDoc(balanceRef, { soldeDepot: 0, soldeGains: 0 });
          soldeDepot = 0;
          soldeGains = 0;
        }
        updateBalances();
      }
    }
    
    async function updateBalances() {
      document.getElementById('soldeDepot').innerText = soldeDepot.toFixed(2) + "$";
      document.getElementById('soldeGains').innerText = soldeGains.toFixed(2) + "$";
      if(currentUser){
        await setDoc(doc(db, "balances", currentUser.uid), { soldeDepot, soldeGains }, { merge: true });
      }
    }
    
    function showNotification(message) {
      const notif = document.createElement("div");
      notif.className = "notification";
      notif.innerText = message;
      document.body.appendChild(notif);
      setTimeout(() => { notif.remove(); }, 2000);
    }
    
    async function addHistorique(type, montant, fee = 0) {
      try {
        await addDoc(collection(db, "historique"), { type, montant, fee, timestamp: new Date() });
        const histContainer = document.getElementById('historique-container');
        const item = document.createElement('div');
        item.className = "historique-item";
        item.innerText = type + " - Montant: " + montant + "$" + (fee ? " - Frais: " + fee + "$" : "");
        histContainer.prepend(item);
      } catch (error) {
        console.error("Erreur lors de l'ajout de l'historique: ", error);
      }
    }
    
    // --- Formulaires Transaction ---
    document.getElementById('btn-depot').addEventListener('click', () => {
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN d'abord.");
        return;
      }
      hideAllForms();
      document.getElementById('form-depot').style.display = 'block';
    });
    document.getElementById('btn-retrait').addEventListener('click', () => {
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN d'abord.");
        return;
      }
      hideAllForms();
      document.getElementById('form-retrait').style.display = 'block';
    });
    document.getElementById('btn-transfert').addEventListener('click', () => {
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN d'abord.");
        return;
      }
      hideAllForms();
      document.getElementById('form-transfert').style.display = 'block';
    });
    function hideAllForms() {
      document.getElementById('form-depot').style.display = 'none';
      document.getElementById('form-retrait').style.display = 'none';
      document.getElementById('form-transfert').style.display = 'none';
    }
    
    window.copyAdresse = function() {
      const select = document.getElementById('adresse-depot');
      const address = select.value;
      navigator.clipboard.writeText(address).then(() => {
        showNotification("Adresse copiée: " + address);
      });
    };
    
    // Dépôt
    document.getElementById('form-depot').addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN pour effectuer cette opération.");
        return;
      }
      const montant = parseFloat(document.getElementById('depot-montant').value);
      if(montant < 10) {
        showNotification("Le dépôt minimum est de 10$");
        return;
      }
      const adresse = document.getElementById('adresse-depot').value;
      const idTransaction = document.getElementById('id-transaction').value;
      try {
        await addDoc(collection(db, "depots"), {
          montant, adresse, idTransaction,
          status: "pending",
          timestamp: new Date()
        });
        showNotification("Demande de dépôt envoyée");
      } catch (error) {
        console.error("Erreur lors du dépôt: ", error);
      }
    });
    
    // Retrait
    document.getElementById('form-retrait').addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN pour effectuer cette opération.");
        return;
      }
      const montant = parseFloat(document.getElementById('retrait-montant').value);
      if(montant < 1) {
        showNotification("Le retrait minimum est de 1$");
        return;
      }
      const adresseRetrait = document.getElementById('adresse-retrait').value;
      try {
        await addDoc(collection(db, "retraits"), {
          montant, adresseRetrait,
          status: "pending",
          timestamp: new Date()
        });
        showNotification("Demande de retrait envoyée");
      } catch (error) {
        console.error("Erreur lors du retrait: ", error);
      }
    });
    
    // Transfert d'argent
    document.getElementById('form-transfert').addEventListener('submit', async (e) => {
      e.preventDefault();
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN pour effectuer cette opération.");
        return;
      }
      const montant = parseFloat(document.getElementById('transfert-montant').value);
      if(montant < 5) {
        showNotification("Le transfert minimum est de 5$");
        return;
      }
      const emailUtilisateur = document.getElementById('email-utilisateur').value;
      if(emailUtilisateur === currentUser.email) {
        showNotification("Vous ne pouvez pas effectuer de transfert vers votre propre compte.");
        return;
      }
      const receptionType = document.getElementById('reception-type').value;
      const fee = montant * 0.05;
      if(soldeGains < (montant + fee)) {
        showNotification("Solde insuffisant pour le transfert.");
        return;
      }
      const recipientQuery = query(collection(db, "utilisateurs"), where("email", "==", emailUtilisateur));
      const recipientSnapshot = await getDocs(recipientQuery);
      if(recipientSnapshot.empty) {
        showNotification("Utilisateur non trouvé pour cet email.");
        return;
      }
      const recipientDoc = recipientSnapshot.docs[0];
      const recipientUid = recipientDoc.id;
      soldeGains -= (montant + fee);
      await updateBalances();
      const recipientBalanceRef = doc(db, "balances", recipientUid);
      const recipientBalanceSnap = await getDoc(recipientBalanceRef);
      let recipientSolde = 0;
      if(recipientBalanceSnap.exists()){
        recipientSolde = recipientBalanceSnap.data()[receptionType === "depot" ? "soldeDepot" : "soldeGains"] || 0;
      }
      recipientSolde += montant;
      await setDoc(recipientBalanceRef, { [receptionType === "depot" ? "soldeDepot" : "soldeGains"]: recipientSolde }, { merge: true });
      await addDoc(collection(db, "transferts"), {
        montant, emailUtilisateur, fee, receptionType,
        status: "confirmed",
        timestamp: new Date()
      });
      addHistorique("Transfert", montant, fee);
      showNotification("Transfert effectué vers " + emailUtilisateur);
    });
    
    // --- Section TRADING (Automatique, une fois par 24h) ---
    const tradingButton = document.getElementById('btn-trading');
    const tradingStatus = document.getElementById('trading-status');
    const notificationTrading = document.getElementById('notification-trading');
    
    tradingButton.addEventListener('click', async () => {
      if(!currentUser) {
        showNotification("Veuillez vérifier votre CIN pour effectuer cette opération.");
        return;
      }
      const balanceRef = doc(db, "balances", currentUser.uid);
      const balanceSnap = await getDoc(balanceRef);
      if(balanceSnap.exists()){
        const data = balanceSnap.data();
        if(data.lastTrading) {
          const lastTradingTime = data.lastTrading.toDate ? data.lastTrading.toDate() : data.lastTrading;
          const now = new Date();
          if(now - lastTradingTime < 24 * 60 * 60 * 1000) {
            showNotification("Trading déjà effectué. Veuillez patienter 24h.");
            return;
          }
        }
      }
      tradingButton.disabled = true;
      tradingStatus.innerText = "Acheter";
      setTimeout(() => {
        tradingStatus.innerText = "Vendre";
        setTimeout(async () => {
          tradingStatus.innerText = "Tâche terminée";
          if(soldeDepot >= 10 && soldeDepot < 200) {
            currentGain = soldeDepot * 0.025;
          } else if(soldeDepot >= 200 && soldeDepot < 500) {
            currentGain = soldeDepot * 0.026;
          } else if(soldeDepot >= 500) {
            currentGain = soldeDepot * 0.03;
          } else {
            currentGain = 0;
          }
          document.getElementById("gain-robot").innerText = currentGain.toFixed(2) + "$";
          notificationTrading.style.display = "block";
          await setDoc(doc(db, "balances", currentUser.uid), { lastTrading: new Date() }, { merge: true });
        }, 5000);
      }, 5000);
    });
    
    document.getElementById('btn-ajouter-gains').addEventListener('click', () => {
      if(currentGain > 0) {
        soldeGains += currentGain;
        updateBalances();
        showNotification("Gains ajoutés: " + currentGain.toFixed(2) + "$");
        currentGain = 0;
        notificationTrading.style.display = "none";
      } else {
        showNotification("Trading déjà effectué ou aucun gain disponible.");
      }
    });
    // --- Fin TRADING ---
    
    // --- Tabilao de Confirmation (Admin) ---
    document.getElementById('btn-show-confirmation').addEventListener('click', () => {
      const adminCode = document.getElementById('admin-code').value;
      if(adminCode === "080600") {
        document.getElementById('confirmation-container').style.display = "block";
        refreshConfirmationTable();
      } else {
        showNotification("Code d'accès incorrect !");
      }
    });
    
    async function refreshConfirmationTable() {
      const tbody = document.getElementById('confirmation-body');
      tbody.innerHTML = "";
      const depotQuery = query(collection(db, "depots"), where("status", "==", "pending"));
      const depotSnapshot = await getDocs(depotQuery);
      depotSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Dépôt</td>
                        <td>${data.montant}$</td>
                        <td>${data.adresse}</td>
                        <td>${data.idTransaction}</td>
                        <td>
                          <button onclick="confirmTransaction('${docSnap.id}', 'depot', ${data.montant})">Confirmer</button>
                          <button onclick="cancelTransaction('${docSnap.id}', 'depot')">Annuler</button>
                        </td>`;
        tbody.appendChild(tr);
      });
      const retraitQuery = query(collection(db, "retraits"), where("status", "==", "pending"));
      const retraitSnapshot = await getDocs(retraitQuery);
      retraitSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Retrait</td>
                        <td>${data.montant}$</td>
                        <td>${data.adresseRetrait}</td>
                        <td>-</td>
                        <td>
                          <button onclick="confirmTransaction('${docSnap.id}', 'retrait', ${data.montant})">Confirmer</button>
                          <button onclick="cancelTransaction('${docSnap.id}', 'retrait')">Annuler</button>
                        </td>`;
        tbody.appendChild(tr);
      });
    }
    
    window.confirmTransaction = async function(docId, type, montant) {
      const adminCode = document.getElementById('admin-code').value;
      if(adminCode !== "080600") {
        showNotification("Code d'accès incorrect !");
        return;
      }
      if(type === "depot") {
        try {
          await updateDoc(doc(db, "depots", docId), { status: "confirmed" });
          soldeDepot += montant;
          await updateBalances();
          addHistorique("Dépôt", montant);
          showNotification("Dépôt confirmé");
          refreshConfirmationTable();
        } catch (err) {
          console.error("Erreur lors de la confirmation du dépôt", err);
        }
      } else if(type === "retrait") {
        try {
          const fee = montant * 0.10;
          if(soldeGains >= montant) {
            await updateDoc(doc(db, "retraits", docId), { status: "confirmed" });
            soldeGains -= montant;
            await updateBalances();
            addHistorique("Retrait", montant - fee, fee);
            showNotification("Retrait confirmé (frais: " + fee + "$)");
            refreshConfirmationTable();
          } else {
            showNotification("Solde insuffisant pour le retrait.");
          }
        } catch (err) {
          console.error("Erreur lors de la confirmation du retrait", err);
        }
      }
    }
    
    window.cancelTransaction = async function(docId, type) {
      const adminCode = document.getElementById('admin-code').value;
      if(adminCode !== "080600") {
        showNotification("Code d'accès incorrect !");
        return;
      }
      try {
        await updateDoc(doc(db, type === "depot" ? "depots" : "retraits", docId), { status: "annuler" });
        showNotification(type === "depot" ? "Dépôt annulé" : "Retrait annulé");
        refreshConfirmationTable();
      } catch (err) {
        console.error("Erreur lors de l'annulation", err);
      }
    }
    
    updateBalances();
  </script>
  
  
  
  
  
  
 <script >// Fonction pour gérer l'upload et la sauvegarde dans le localStorage
function handleFileInput(inputElement, imgElementId, storageKey) {
  const file = inputElement.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const imgElement = document.getElementById(imgElementId);
      imgElement.src = e.target.result;
      // Sauvegarde de l'image dans le localStorage
      try {
        localStorage.setItem(storageKey, e.target.result);
      } catch (error) {
        console.error("Erreur lors de la sauvegarde dans localStorage", error);
      }
    }
    reader.readAsDataURL(file);
  }
}

// Au chargement de la page, récupère les images sauvegardées (si elles existent)
document.addEventListener('DOMContentLoaded', function() {
  const storedProfile = localStorage.getItem('profileImage');
  if (storedProfile) {
    document.getElementById('profileImg').src = storedProfile;
  }
  
  const storedCover = localStorage.getItem('coverImage');
  if (storedCover) {
    document.getElementById('coverImg').src = storedCover;
  }
});

// Ouvre la fenêtre de sélection de fichier pour la couverture
document.getElementById('uploadCover').addEventListener('click', function() {
  document.getElementById('coverInput').click();
});

document.getElementById('coverInput').addEventListener('change', function() {
  handleFileInput(this, 'coverImg', 'coverImage');
});

// Ouvre la fenêtre de sélection de fichier pour la photo de profil
document.getElementById('uploadProfile').addEventListener('click', function() {
  document.getElementById('profileInput').click();
});

document.getElementById('profileInput').addEventListener('change', function() {
  handleFileInput(this, 'profileImg', 'profileImage');
});

// Affichage du modal pour agrandir la photo de profil
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const profilePhoto = document.getElementById("profilePhoto");

profilePhoto.addEventListener('click', function() {
  modal.style.display = "block";
  modalImg.src = document.getElementById('profileImg').src;
});

// Fermeture du modal en cliquant sur le "×"
document.querySelector('.close').addEventListener('click', function() {
  modal.style.display = "none";
});

// Fermeture du modal en cliquant en dehors de l'image
modal.addEventListener('click', function(e) {
  if (e.target === modal) {
    modal.style.display = "none";
  }
});
</script>
</body>
  </html>
